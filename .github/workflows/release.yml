name: "üöÄ Release"

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

env:
  BINARY_NAME: ${{ github.event.repository.name }}
  HOMEBREW_TAP_REPOSITORY: fang2hou/homebrew-tap
  HOMEBREW_FORMULA_NAME: ${{ github.event.repository.name }}
  HOMEBREW_SERVICE_SUBCOMMAND: serve
  PROJECT_DESCRIPTION: High-performance LLM API proxy with automatic retry and fallback

jobs:
  release:
    name: "üì¶ Build and Release"
    runs-on: ubuntu-latest
    steps:
      - name: "üì• Checkout"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "üêπ Setup Go"
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"

      - name: "üì¶ Setup cocogitto"
        uses: cocogitto/cocogitto-action@v3

      - name: "üìù Generate changelog"
        run: |
          PREV_TAG=""
          for tag in $(git tag --sort=-version:refname); do
            if [ "$tag" = "${{ github.ref_name }}" ]; then
              continue
            fi
            if git merge-base --is-ancestor "$tag" "${{ github.ref_name }}"; then
              PREV_TAG="$tag"
              break
            fi
          done
          if [ -n "$PREV_TAG" ]; then
            cog changelog "${PREV_TAG}..${{ github.ref_name }}" --template full_hash > RELEASE_NOTES.md
          else
            cog changelog --template full_hash > RELEASE_NOTES.md
          fi

      - name: "üî® Build binaries"
        run: |
          mkdir -p dist

          LDFLAGS="-s -w -X main.version=${{ github.ref_name }} -X main.commit=${{ github.sha }} -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # Linux
          GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-linux-amd64" .
          GOOS=linux GOARCH=arm64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-linux-arm64" .

          # macOS
          GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-darwin-amd64" .
          GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-darwin-arm64" .

          # Windows
          GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-windows-amd64.exe" .
          GOOS=windows GOARCH=arm64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-windows-arm64.exe" .

      - name: "üì¶ Create archives"
        run: |
          set -euo pipefail
          shopt -s nullglob
          cd dist
          bins=("${BINARY_NAME}"-*)
          if [ ${#bins[@]} -eq 0 ]; then
            echo "No built binaries found for pattern: ${BINARY_NAME}-*"
            exit 1
          fi
          for bin in "${bins[@]}"; do
            # Rename binary to remove arch suffix inside archive
            base="${bin%.exe}"
            if [[ "$bin" == *.exe ]]; then
              mv "$bin" "${BINARY_NAME}.exe"
              zip "${base}.zip" "${BINARY_NAME}.exe"
              rm "${BINARY_NAME}.exe"
            else
              mv "$bin" "${BINARY_NAME}"
              tar -czf "${base}.tar.gz" "${BINARY_NAME}"
              rm "${BINARY_NAME}"
            fi
          done

      - name: "üéâ Create GitHub release"
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.BINARY_NAME }}-*.{tar.gz,zip}
          body_path: RELEASE_NOTES.md
          tag_name: ${{ github.ref_name }}

      - name: "üì§ Upload artifacts for homebrew update"
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: |
            dist/${{ env.BINARY_NAME }}-*.tar.gz
          retention-days: 1

  update-homebrew:
    name: "üç∫ Update Homebrew Tap"
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: "üì• Download artifacts"
        uses: actions/download-artifact@v4
        with:
          name: release-info
          path: dist

      - name: "üì• Checkout homebrew-tap"
        uses: actions/checkout@v6
        with:
          repository: ${{ env.HOMEBREW_TAP_REPOSITORY }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: "üìù Update formula"
        run: |
          set -euo pipefail
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          BINARY_NAME="${{ env.BINARY_NAME }}"
          FORMULA_NAME="${{ env.HOMEBREW_FORMULA_NAME }}"
          FORMULA_CLASS="$(echo "$FORMULA_NAME" | sed -E 's/(^|[-_])([a-z])/\U\2/g')"
          PROJECT_HOMEPAGE="${{ vars.PROJECT_HOMEPAGE || format('https://github.com/{0}', github.repository) }}"
          PROJECT_DESC="${{ vars.PROJECT_DESCRIPTION || 'CLI application' }}"
          SERVICE_SUBCOMMAND="${{ env.HOMEBREW_SERVICE_SUBCOMMAND }}"

          FORMULA="homebrew-tap/Formula/${FORMULA_NAME}.rb"
          TEMPLATE_FILE=".github/templates/homebrew-formula.rb.tpl"
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"

          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Template file not found: $TEMPLATE_FILE"
            exit 1
          fi

          # Calculate sha256 from local files
          required_files=(
            "dist/${BINARY_NAME}-darwin-amd64.tar.gz"
            "dist/${BINARY_NAME}-darwin-arm64.tar.gz"
            "dist/${BINARY_NAME}-linux-amd64.tar.gz"
            "dist/${BINARY_NAME}-linux-arm64.tar.gz"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing release artifact: $file"
              exit 1
            fi
          done

          DARWIN_AMD64_SHA=$(sha256sum "dist/${BINARY_NAME}-darwin-amd64.tar.gz" | cut -d' ' -f1)
          DARWIN_ARM64_SHA=$(sha256sum "dist/${BINARY_NAME}-darwin-arm64.tar.gz" | cut -d' ' -f1)
          LINUX_AMD64_SHA=$(sha256sum "dist/${BINARY_NAME}-linux-amd64.tar.gz" | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(sha256sum "dist/${BINARY_NAME}-linux-arm64.tar.gz" | cut -d' ' -f1)

          python3 - << 'PY'
          import os
          from pathlib import Path

          template = Path(os.environ["TEMPLATE_FILE"]).read_text(encoding="utf-8")
          replacements = {
              "FORMULA_CLASS": os.environ["FORMULA_CLASS"],
              "PROJECT_DESC": os.environ["PROJECT_DESC"],
              "PROJECT_HOMEPAGE": os.environ["PROJECT_HOMEPAGE"],
              "VERSION": os.environ["VERSION"],
              "BASE_URL": os.environ["BASE_URL"],
              "BINARY_NAME": os.environ["BINARY_NAME"],
              "DARWIN_AMD64_SHA": os.environ["DARWIN_AMD64_SHA"],
              "DARWIN_ARM64_SHA": os.environ["DARWIN_ARM64_SHA"],
              "LINUX_AMD64_SHA": os.environ["LINUX_AMD64_SHA"],
              "LINUX_ARM64_SHA": os.environ["LINUX_ARM64_SHA"],
              "SERVICE_SUBCOMMAND": os.environ["SERVICE_SUBCOMMAND"],
              "FORMULA_NAME": os.environ["FORMULA_NAME"],
          }

          for key, value in replacements.items():
              template = template.replace(f"__{key}__", value)

          unresolved = __import__("re").findall(r"__[A-Z0-9_]+__", template)
          if unresolved:
              raise SystemExit(f"Unresolved placeholders in formula template: {', '.join(sorted(set(unresolved)))}")

          Path(os.environ["FORMULA"]).write_text(template, encoding="utf-8")
          PY

          echo "Updated ${FORMULA_NAME} formula to version ${VERSION}"

      - name: "üöÄ Push to homebrew-tap"
        run: |
          set -euo pipefail
          cd homebrew-tap
          FORMULA_NAME="${{ env.HOMEBREW_FORMULA_NAME }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${FORMULA_NAME}.rb"
          if git diff --cached --quiet; then
            echo "No formula changes detected, skipping commit."
            exit 0
          fi
          git commit -m "chore: update ${FORMULA_NAME} to ${{ github.ref_name }}"
          git push
