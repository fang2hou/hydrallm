name: "ðŸš€ Release"

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  BINARY_NAME: ${{ github.event.repository.name }}
  HOMEBREW_TAP_REPOSITORY: fang2hou/homebrew-tap
  HOMEBREW_FORMULA_NAME: ${{ github.event.repository.name }}
  HOMEBREW_SERVICE_SUBCOMMAND: serve
  PROJECT_DESCRIPTION: High-performance LLM API proxy with automatic retry and fallback

jobs:
  release:
    name: "ðŸ“¦ Build and Release"
    if: startsWith(github.repository, 'fang2hou/')
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "ðŸ¹ Setup Go"
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"

      - name: "ðŸ“¦ Setup cocogitto"
        uses: cocogitto/cocogitto-action@v4
        with:
          command: --version

      - name: "ðŸ“ Generate changelog"
        run: |
          PREV_TAG=""
          for tag in $(git tag --sort=-version:refname); do
            if [ "$tag" = "${{ github.ref_name }}" ]; then
              continue
            fi
            if git merge-base --is-ancestor "$tag" "${{ github.ref_name }}"; then
              PREV_TAG="$tag"
              break
            fi
          done
          if [ -n "$PREV_TAG" ]; then
            cog changelog "${PREV_TAG}..${{ github.ref_name }}" --template full_hash > RELEASE_NOTES.md
          else
            cog changelog --template full_hash > RELEASE_NOTES.md
          fi

      - name: "ðŸ§¹ Normalize changelog formatting"
        run: |
          awk '
            BEGIN {
              prev_was_bullet = 0
              pending_blank = 0
            }

            {
              if ($0 ~ /^[[:space:]]*$/) {
                pending_blank = 1
                next
              }

              is_bullet = ($0 ~ /^- /)

              if (pending_blank) {
                if (!(prev_was_bullet && is_bullet)) {
                  print ""
                }
                pending_blank = 0
              }

              print
              prev_was_bullet = is_bullet
            }
          ' RELEASE_NOTES.md > RELEASE_NOTES.normalized.md

          mv RELEASE_NOTES.normalized.md RELEASE_NOTES.md

      - name: "ðŸ”¨ Build binaries"
        run: |
          mkdir -p dist

          LDFLAGS="-s -w -X main.version=${{ github.ref_name }} -X main.commit=${{ github.sha }} -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          # Linux
          GOOS=linux GOARCH=amd64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-linux-amd64" .
          GOOS=linux GOARCH=arm64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-linux-arm64" .

          # macOS
          GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-darwin-amd64" .
          GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-darwin-arm64" .

          # Windows
          GOOS=windows GOARCH=amd64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-windows-amd64.exe" .
          GOOS=windows GOARCH=arm64 go build -ldflags "$LDFLAGS" -o "dist/${BINARY_NAME}-windows-arm64.exe" .

      - name: "ðŸ“¦ Create archives"
        run: |
          set -euo pipefail
          shopt -s nullglob
          cd dist
          bins=("${BINARY_NAME}"-*)
          if [ ${#bins[@]} -eq 0 ]; then
            echo "No built binaries found for pattern: ${BINARY_NAME}-*"
            exit 1
          fi
          for bin in "${bins[@]}"; do
            # Rename binary to remove arch suffix inside archive
            base="${bin%.exe}"
            if [[ "$bin" == *.exe ]]; then
              mv "$bin" "${BINARY_NAME}.exe"
              zip "${base}.zip" "${BINARY_NAME}.exe"
              rm "${BINARY_NAME}.exe"
            else
              mv "$bin" "${BINARY_NAME}"
              tar -czf "${base}.tar.gz" "${BINARY_NAME}"
              rm "${BINARY_NAME}"
            fi
          done

      - name: "ðŸŽ‰ Create GitHub release"
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ env.BINARY_NAME }}-*.{tar.gz,zip}
          body_path: RELEASE_NOTES.md
          tag_name: ${{ github.ref_name }}

      - name: "ðŸ“¤ Upload artifacts for homebrew update"
        uses: actions/upload-artifact@v6
        with:
          name: release-info
          path: |
            dist/${{ env.BINARY_NAME }}-*.tar.gz
          retention-days: 1

  update-homebrew:
    name: "ðŸº Update Homebrew Tap"
    if: startsWith(github.repository, 'fang2hou/')
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: "ðŸ“¥ Download artifacts"
        uses: actions/download-artifact@v7
        with:
          name: release-info
          path: dist

      - name: "ðŸ“¥ Checkout source repository"
        uses: actions/checkout@v6
        with:
          path: source

      - name: "ðŸ“¥ Checkout homebrew-tap"
        uses: actions/checkout@v6
        with:
          repository: ${{ env.HOMEBREW_TAP_REPOSITORY }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: "ðŸ“ Update formula"
        run: |
          set -euo pipefail
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          BINARY_NAME="${{ env.BINARY_NAME }}"
          FORMULA_NAME="${{ env.HOMEBREW_FORMULA_NAME }}"
          FORMULA_CLASS="$(echo "$FORMULA_NAME" | sed -E 's/(^|[-_])([a-z])/\U\2/g')"
          PROJECT_HOMEPAGE="${{ env.PROJECT_HOMEPAGE || format('https://github.com/{0}', github.repository) }}"
          PROJECT_DESC="${{ env.PROJECT_DESCRIPTION || 'CLI application' }}"
          SERVICE_SUBCOMMAND="${{ env.HOMEBREW_SERVICE_SUBCOMMAND }}"

          FORMULA="homebrew-tap/Formula/${FORMULA_NAME}.rb"
          TEMPLATE_FILE="source/.github/templates/homebrew-formula.rb.tpl"
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"

          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Template file not found: $TEMPLATE_FILE"
            exit 1
          fi

          # Calculate sha256 from local files
          required_files=(
            "dist/${BINARY_NAME}-darwin-amd64.tar.gz"
            "dist/${BINARY_NAME}-darwin-arm64.tar.gz"
            "dist/${BINARY_NAME}-linux-amd64.tar.gz"
            "dist/${BINARY_NAME}-linux-arm64.tar.gz"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing release artifact: $file"
              exit 1
            fi
          done

          DARWIN_AMD64_SHA=$(sha256sum "dist/${BINARY_NAME}-darwin-amd64.tar.gz" | cut -d' ' -f1)
          DARWIN_ARM64_SHA=$(sha256sum "dist/${BINARY_NAME}-darwin-arm64.tar.gz" | cut -d' ' -f1)
          LINUX_AMD64_SHA=$(sha256sum "dist/${BINARY_NAME}-linux-amd64.tar.gz" | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(sha256sum "dist/${BINARY_NAME}-linux-arm64.tar.gz" | cut -d' ' -f1)

            sed \
              -e "s|__FORMULA_CLASS__|${FORMULA_CLASS}|g" \
              -e "s|__PROJECT_DESC__|${PROJECT_DESC}|g" \
              -e "s|__PROJECT_HOMEPAGE__|${PROJECT_HOMEPAGE}|g" \
              -e "s|__VERSION__|${VERSION}|g" \
              -e "s|__BASE_URL__|${BASE_URL}|g" \
              -e "s|__BINARY_NAME__|${BINARY_NAME}|g" \
              -e "s|__DARWIN_AMD64_SHA__|${DARWIN_AMD64_SHA}|g" \
              -e "s|__DARWIN_ARM64_SHA__|${DARWIN_ARM64_SHA}|g" \
              -e "s|__LINUX_AMD64_SHA__|${LINUX_AMD64_SHA}|g" \
              -e "s|__LINUX_ARM64_SHA__|${LINUX_ARM64_SHA}|g" \
              -e "s|__SERVICE_SUBCOMMAND__|${SERVICE_SUBCOMMAND}|g" \
              -e "s|__FORMULA_NAME__|${FORMULA_NAME}|g" \
              "$TEMPLATE_FILE" > "$FORMULA"

          echo "Updated ${FORMULA_NAME} formula to version ${VERSION}"

      - name: "ðŸš€ Push to homebrew-tap"
        run: |
          set -euo pipefail
          cd homebrew-tap
          FORMULA_NAME="${{ env.HOMEBREW_FORMULA_NAME }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${FORMULA_NAME}.rb"
          if git diff --cached --quiet; then
            echo "No formula changes detected, skipping commit."
            exit 0
          fi
          git commit -m "chore: update ${FORMULA_NAME} to ${{ github.ref_name }}"
          git push
